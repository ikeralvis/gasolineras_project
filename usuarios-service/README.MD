# üîê Microservicio de Usuarios

Microservicio para gesti√≥n de usuarios, autenticaci√≥n JWT y favoritos de estaciones de servicio.

## üìã Tabla de Contenidos

- [Tecnolog√≠as](#tecnolog√≠as)
- [Caracter√≠sticas](#caracter√≠sticas)
- [Requisitos Previos](#requisitos-previos)
- [Instalaci√≥n](#instalaci√≥n)
- [Configuraci√≥n](#configuraci√≥n)
- [Uso](#uso)
- [Endpoints API](#endpoints-api)
- [Autenticaci√≥n](#autenticaci√≥n)
- [Base de Datos](#base-de-datos)
- [Testing con Swagger](#testing-con-swagger)
- [Despliegue con Docker](#despliegue-con-docker)

## üöÄ Tecnolog√≠as

- **Node.js** v20+
- **Fastify** - Framework web de alto rendimiento
- **PostgreSQL 16** - Base de datos relacional
- **JWT** - Autenticaci√≥n basada en tokens
- **bcryptjs** - Hash seguro de contrase√±as
- **Swagger/OpenAPI** - Documentaci√≥n interactiva de la API
- **Docker** - Contenedorizaci√≥n

## ‚ú® Caracter√≠sticas

- Registro y autenticaci√≥n de usuarios
- Tokens JWT con expiraci√≥n configurable
- Hash seguro de contrase√±as con bcrypt
- Gesti√≥n de favoritos (estaciones de servicio)
- Control de acceso basado en roles (admin)
- Documentaci√≥n interactiva con Swagger UI
- Validaci√≥n de esquemas con JSON Schema
- Logs estructurados
- Protecci√≥n con Helmet (seguridad HTTP)

## üì¶ Requisitos Previos

- Node.js 20+ y npm
- PostgreSQL 16+
- Docker y Docker Compose (opcional)

## üîß Instalaci√≥n

### Opci√≥n 1: Local

```bash
# Clonar el repositorio
cd usuarios-service

# Instalar dependencias
npm install

# Configurar variables de entorno
cp .env.example .env
# Edita .env con tus credenciales

# Inicializar base de datos
psql -U postgres -d usuarios_db < init.sql

# Ejecutar en desarrollo
npm run dev

# Ejecutar en producci√≥n
npm start
```

### Opci√≥n 2: Docker Compose

```bash
# Desde la ra√≠z del proyecto
docker-compose up -d usuarios postgres
```

## ‚öôÔ∏è Configuraci√≥n

Crea un archivo `.env` en la ra√≠z del proyecto:

```env
# Servidor
PORT=3001
HOST=0.0.0.0
NODE_ENV=development

# Base de Datos PostgreSQL
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=tu_password_seguro
DB_NAME=usuarios_db

# JWT
JWT_SECRET=tu_secreto_super_seguro_cambiame_en_produccion
JWT_EXPIRES_IN=7d
```

‚ö†Ô∏è **IMPORTANTE**: Cambia `JWT_SECRET` por un valor aleatorio y seguro en producci√≥n.

## üéØ Uso

### Servidor Local

Una vez iniciado, el servidor estar√° disponible en:

- **API Base**: `http://localhost:3001/api/usuarios`
- **Swagger UI**: `http://localhost:3001/api-docs`
- **Health Check**: `http://localhost:3001/api/usuarios/me` (requiere autenticaci√≥n)

## üì° Endpoints API

### P√∫blicos (sin autenticaci√≥n)

#### `POST /api/usuarios/register`
Registrar un nuevo usuario.

**Request:**
```json
{
  "nombre": "Juan P√©rez",
  "email": "juan@example.com",
  "password": "password123"
}
```

**Response (201):**
```json
{
  "id": 1,
  "nombre": "Juan P√©rez",
  "email": "juan@example.com"
}
```

#### `POST /api/usuarios/login`
Iniciar sesi√≥n y obtener token JWT.

**Request:**
```json
{
  "email": "juan@example.com",
  "password": "password123"
}
```

**Response (200):**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### Protegidos (requieren autenticaci√≥n)

> üîí Todos los endpoints siguientes requieren el header: `Authorization: Bearer <token>`

#### `GET /api/usuarios/me`
Obtener informaci√≥n del usuario autenticado.

**Response (200):**
```json
{
  "id": 1,
  "nombre": "Juan P√©rez",
  "email": "juan@example.com",
  "is_admin": false
}
```

#### `POST /api/usuarios/favoritos`
A√±adir una estaci√≥n de servicio a favoritos.

**Request:**
```json
{
  "ideess": "12345"
}
```

**Response (201):**
```json
{
  "message": "Favorito a√±adido.",
  "ideess": "12345"
}
```

#### `GET /api/usuarios/favoritos`
Obtener lista de favoritos del usuario.

**Response (200):**
```json
[
  {
    "ideess": "12345",
    "created_at": "2025-10-22T19:30:00.000Z"
  },
  {
    "ideess": "67890",
    "created_at": "2025-10-21T15:20:00.000Z"
  }
]
```

### Admin (requieren rol de administrador)

#### `GET /api/usuarios/`
Listar todos los usuarios (solo administradores).

**Response (200):**
```json
[
  {
    "id": 1,
    "nombre": "Juan P√©rez",
    "email": "juan@example.com",
    "is_admin": false
  },
  {
    "id": 2,
    "nombre": "Admin",
    "email": "admin@example.com",
    "is_admin": true
  }
]
```

## üîê Autenticaci√≥n

Este microservicio usa **JWT (JSON Web Tokens)** para autenticaci√≥n.

### Flujo de Autenticaci√≥n

1. **Registro**: El usuario se registra con `POST /register`
2. **Login**: El usuario hace login con `POST /login` y recibe un token
3. **Uso del Token**: El token se env√≠a en cada petici√≥n protegida

### Formato del Token

```http
Authorization: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### Payload del Token

```json
{
  "id": 1,
  "email": "juan@example.com",
  "nombre": "Juan P√©rez",
  "is_admin": false,
  "iat": 1729622400,
  "exp": 1730227200
}
```

### Expiraci√≥n

Los tokens expiran seg√∫n la configuraci√≥n `JWT_EXPIRES_IN` (por defecto: 7 d√≠as).

## üóÑÔ∏è Base de Datos

### Esquema PostgreSQL

#### Tabla `users`

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    nombre VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    is_admin BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### Tabla `user_favorites`

```sql
CREATE TABLE user_favorites (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    ideess VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, ideess)
);
```

### Inicializar Base de Datos

```bash
# Ejecutar script de inicializaci√≥n
psql -U postgres -d usuarios_db < init.sql

# O con Docker
docker exec -i postgres psql -U postgres -d usuarios_db < init.sql
```

## üß™ Testing con Swagger

### Acceder a Swagger UI

Abre tu navegador en: `http://localhost:3001/api-docs`

### Probar Endpoints Protegidos

1. **Haz Login**:
   - Ve a `POST /api/usuarios/login`
   - Ejecuta con credenciales v√°lidas
   - **Copia el token** de la respuesta

2. **Autorizar en Swagger**:
   - Haz clic en el bot√≥n **"Authorize"** üîì (esquina superior derecha)
   - Pega: `TU_TOKEN_AQUI`
   - Haz clic en "Authorize"
   - Cierra el modal

3. **Probar Endpoints**:
   - Ahora todos los endpoints protegidos (con candado üîí) funcionar√°n
   - Prueba `GET /api/usuarios/me` para verificar

## üê≥ Despliegue con Docker

### Docker Compose

Ver archivo `docker-compose.yml` en la ra√≠z del proyecto.

```bash
# Levantar todos los servicios
docker-compose up -d

# Ver logs
docker logs -f usuarios-service

# Detener
docker-compose down
```

## üìä C√≥digos de Estado HTTP

| C√≥digo | Descripci√≥n |
|--------|-------------|
| 200 | ‚úÖ OK - Solicitud exitosa |
| 201 | ‚úÖ Created - Recurso creado |
| 400 | ‚ùå Bad Request - Datos inv√°lidos |
| 401 | ‚ùå Unauthorized - Token inv√°lido o ausente |
| 403 | ‚ùå Forbidden - Sin permisos (no admin) |
| 500 | ‚ùå Internal Server Error - Error del servidor |

## üîí Seguridad

- ‚úÖ Contrase√±as hasheadas con bcrypt (10 rounds)
- ‚úÖ Tokens JWT firmados con secreto
- ‚úÖ Validaci√≥n de entrada con JSON Schema
- ‚úÖ Headers de seguridad con Helmet
- ‚úÖ Prevenci√≥n de duplicados en favoritos
- ‚úÖ Protecci√≥n contra SQL injection (queries parametrizadas)
- ‚ö†Ô∏è **No olvides cambiar JWT_SECRET en producci√≥n**

---

**Desarrollado con ‚ù§Ô∏è para el proyecto TankGo**