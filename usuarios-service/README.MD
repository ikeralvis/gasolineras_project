# ğŸ” Microservicio de Usuarios

Microservicio de autenticaciÃ³n y gestiÃ³n de usuarios con JWT, construido con **Fastify** y **PostgreSQL**.

---

## ğŸš€ TecnologÃ­as

- **Node.js 20** + **Fastify** (framework rÃ¡pido y moderno)
- **PostgreSQL 16** (base de datos relacional)
- **JWT** (autenticaciÃ³n con tokens)
- **bcryptjs** (hash seguro de contraseÃ±as)
- **Swagger/OpenAPI** (documentaciÃ³n interactiva)
- **Docker** (contenedorizaciÃ³n)

---

## âœ¨ CaracterÃ­sticas

âœ… Registro y autenticaciÃ³n de usuarios  
âœ… Tokens JWT con expiraciÃ³n configurable  
âœ… GestiÃ³n de favoritos (gasolineras)  
âœ… Control de acceso por roles (admin)  
âœ… DocumentaciÃ³n Swagger UI automÃ¡tica  
âœ… ValidaciÃ³n de datos con JSON Schema  
âœ… Seguridad con Helmet y bcrypt  

---

## ğŸ“¦ InstalaciÃ³n

### Con Docker (Recomendado)
```bash
# Desde la raÃ­z del proyecto
docker-compose up -d usuarios postgres
```

### Manual (Desarrollo Local)
```bash
cd usuarios-service
npm install

# Copiar y configurar variables de entorno
cp .env.example .env
# Edita .env con tus credenciales

npm run dev
```

---

## âš™ï¸ Variables de Entorno

Crea un archivo `.env` basado en `.env.example`:

```env
# Servidor
PORT=3001
HOST=0.0.0.0

# PostgreSQL (usar 'postgres' en Docker, 'localhost' en local)
DB_HOST=postgres
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=tu_password
DB_NAME=usuarios_db

# JWT (âš ï¸ cambiar en producciÃ³n)
JWT_SECRET=cambiar_por_secreto_aleatorio_seguro
JWT_EXPIRES_IN=7d
```

**âš ï¸ IMPORTANTE**: Genera un `JWT_SECRET` seguro con:
```bash
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
```

---

## ğŸŒ Endpoints Principales

### ğŸ“„ DocumentaciÃ³n
- **Swagger UI**: http://localhost:3001/api-docs
- **Health Check**: `GET /api/usuarios/health`

### ğŸ”“ PÃºblicos (sin autenticaciÃ³n)

| MÃ©todo | Endpoint | DescripciÃ³n |
|--------|----------|-------------|
| POST | `/api/usuarios/register` | Registrar usuario |
| POST | `/api/usuarios/login` | Login (devuelve JWT) |

### ğŸ”’ Protegidos (requieren token JWT)

| MÃ©todo | Endpoint | DescripciÃ³n |
|--------|----------|-------------|
| GET | `/api/usuarios/me` | Obtener perfil |
| PATCH | `/api/usuarios/me` | Actualizar perfil |
| DELETE | `/api/usuarios/me` | Eliminar cuenta |
| GET | `/api/usuarios/favoritos` | Listar favoritos |
| POST | `/api/usuarios/favoritos` | AÃ±adir favorito |
| DELETE | `/api/usuarios/favoritos/:ideess` | Eliminar favorito |

### ğŸ‘‘ Admin (requieren rol admin)

| MÃ©todo | Endpoint | DescripciÃ³n |
|--------|----------|-------------|
| GET | `/api/usuarios/` | Listar todos los usuarios |

---

## ğŸ” AutenticaciÃ³n

### Flujo BÃ¡sico
```bash
# 1. Registro
curl -X POST http://localhost:3001/api/usuarios/register \
  -H "Content-Type: application/json" \
  -d '{"nombre":"Juan","email":"juan@test.com","password":"123456"}'

# 2. Login (obtener token)
curl -X POST http://localhost:3001/api/usuarios/login \
  -H "Content-Type: application/json" \
  -d '{"email":"juan@test.com","password":"123456"}'
  
# Respuesta: {"token":"eyJhbG..."}

# 3. Usar token en peticiones protegidas
curl http://localhost:3001/api/usuarios/me \
  -H "Authorization: Bearer eyJhbG..."
```

---

## ğŸ—„ï¸ Base de Datos

### Tablas

#### `users`
```sql
- id (SERIAL PRIMARY KEY)
- nombre (VARCHAR)
- email (VARCHAR UNIQUE)
- password_hash (VARCHAR)
- is_admin (BOOLEAN)
- created_at (TIMESTAMP)
```

#### `user_favorites`
```sql
- id (SERIAL PRIMARY KEY)
- user_id (FK â†’ users.id)
- ideess (VARCHAR) -- ID de gasolinera
- created_at (TIMESTAMP)
- UNIQUE(user_id, ideess)
```

La base de datos se inicializa automÃ¡ticamente con `init.sql` al levantar Docker.

---

## ğŸ§ª Probar con Swagger

1. Abre http://localhost:3001/api-docs
2. Ejecuta `POST /login` con credenciales vÃ¡lidas
3. Copia el token de la respuesta
4. Haz clic en **"Authorize"** ğŸ”“ (arriba a la derecha)
5. Pega el token y haz clic en "Authorize"
6. Ahora puedes probar todos los endpoints protegidos ğŸ”’

---

## ğŸ“Š CÃ³digos de Respuesta

| CÃ³digo | Significado |
|--------|-------------|
| 200 | âœ… OK |
| 201 | âœ… Creado |
| 400 | âŒ Datos invÃ¡lidos |
| 401 | âŒ No autenticado |
| 403 | âŒ Sin permisos (no admin) |
| 404 | âŒ No encontrado |
| 500 | âŒ Error del servidor |

---

## ğŸ”’ Seguridad

- âœ… ContraseÃ±as hasheadas con bcrypt (10 rounds)
- âœ… Tokens JWT firmados
- âœ… ValidaciÃ³n de entrada (JSON Schema)
- âœ… Headers de seguridad (Helmet)
- âœ… Queries parametrizadas (prevenciÃ³n SQL injection)
- âœ… CORS configurado
- âš ï¸ Cambiar `JWT_SECRET` en producciÃ³n

---

## ğŸ³ Docker

```bash
# Ver logs
docker logs -f usuarios-service

# Acceder al contenedor
docker exec -it usuarios-service sh

# Reiniciar servicio
docker-compose restart usuarios
```

---

## ğŸ“ Estructura del Proyecto

```
usuarios-service/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.js          # Servidor principal
â”‚   â”œâ”€â”€ db.js             # Plugin de PostgreSQL
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ auth.js       # Rutas de autenticaciÃ³n
â”‚   â”‚   â””â”€â”€ favorites.js  # Rutas de favoritos
â”‚   â””â”€â”€ hooks/
â”‚       â””â”€â”€ authHooks.js  # Middleware de autorizaciÃ³n
â”œâ”€â”€ init.sql              # Schema de la BD
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ package.json
â”œâ”€â”€ .env.example
â””â”€â”€ README.MD
```

---

## ğŸ”— IntegraciÃ³n con Gateway

Este microservicio estÃ¡ diseÃ±ado para funcionar detrÃ¡s del **API Gateway**:

```
Cliente â†’ Gateway:8080 â†’ /api/usuarios/* â†’ usuarios-service:3001
```

El gateway reenvÃ­a automÃ¡ticamente los headers de autenticaciÃ³n.

---

**ğŸ’¡ Tip**: Para mÃ¡s ejemplos de uso, revisa la documentaciÃ³n del Gateway en `/gateway-hono/EXAMPLES.md`